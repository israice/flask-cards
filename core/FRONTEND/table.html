<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Live Table</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <nav class="navbar navbar-light bg-white shadow-sm">
      <div
        class="container-fluid d-flex justify-content-between align-items-center"
      >
        <a class="navbar-brand" href="{{ url_for('root') }}">MyApp</a>
        <div class="d-flex">
          <a id="newPackBtn" class="btn btn-primary me-2" href="#">NEW PACK</a>
          <a class="btn btn-secondary me-2" href="{{ url_for('profile') }}"
            >Back to Profile</a
          >
          <!-- Direct logout link -->
          <a class="btn btn-outline-danger" href="{{ url_for('logout') }}"
            >Log Out</a
          >
        </div>
      </div>
    </nav>

    <div class="container-fluid mt-4">
      <h2 class="mb-3">Live Data Table</h2>
      <div class="table-responsive">
        <table class="table table-bordered table-striped">
          <thead class="table-light" id="table-header"></thead>
          <tbody id="table-body"></tbody>
        </table>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const headerEl = document.getElementById("table-header");
        const bodyEl = document.getElementById("table-body");
        const newPackBtn = document.getElementById("newPackBtn");

        // Render table without reloading the page
        function renderTable({ columns, records }) {
          headerEl.innerHTML = "";
          bodyEl.innerHTML = "";
          if (!records.length) return;

          const headerRow = document.createElement("tr");
          columns.forEach((col) => {
            const th = document.createElement("th");
            th.textContent = col;
            headerRow.appendChild(th);
          });
          headerEl.appendChild(headerRow);

          records.forEach((item) => {
            const row = document.createElement("tr");
            columns.forEach((col) => {
              const td = document.createElement("td");
              td.textContent = item[col];
              row.appendChild(td);
            });
            bodyEl.appendChild(row);
          });
        }

        // AJAX polling using fetch
        function fetchTableData() {
          fetch('{{ url_for("get_users") }}', {
            method: 'GET',
            headers: {
              'Accept': 'application/json'
            }
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
              }
              return response.json();
            })
            .then((data) => {
              renderTable(data);
            })
            .catch((err) => {
              console.error("AJAX fetch error:", err);
            });
        }

        // Start polling every 5 seconds
        fetchTableData(); // immediate initial load
        setInterval(fetchTableData, 5000); // repeat every 5000 ms

        if (newPackBtn) {
          newPackBtn.addEventListener("click", (event) => {
            event.preventDefault();
            const origText = newPackBtn.textContent;
            newPackBtn.textContent = "Success!";
            newPackBtn.classList.replace("btn-primary", "btn-success");
            setTimeout(() => {
              newPackBtn.textContent = origText;
              newPackBtn.classList.replace("btn-success", "btn-primary");
            }, 1000);
          });
        }
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
